<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>가계부 관리 | FinFit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<nav th:replace="~{navbar :: navbarFragment}"></nav>

<div class="container mt-5">
    <h1 class="mb-4 fw-bold text-center">가계부 관리</h1>

	<!-- 월별 요약 -->
	<div class="row text-center mb-4">
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">총 수입</div>
	            <div id="summaryIncome" class="summary-value text-primary"
	                 th:text="${#numbers.formatDecimal(summary.income,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">총 지출</div>
	            <div id="summaryExpense" class="summary-value text-danger"
	                 th:text="${#numbers.formatDecimal(summary.expense,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">잔액</div>
	            <div id="summaryBalance" class="summary-value"
	                 th:text="${#numbers.formatDecimal(summary.balance,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	</div>

    <!-- 가계부 입력 폼 -->
    <div class="card form-card mb-4 p-4">
        <h4 class="mb-3 fw-semibold">새 내역 추가</h4>
        <form th:action="@{/incomeexpense/save}" method="post">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="type" class="form-label">타입</label>
                    <select id="type" name="type" class="form-select" required>
                        <option value="INCOME">수입</option>
                        <option value="EXPENSE">지출</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">카테고리</label>
                    <input type="text" id="category" name="category" class="form-control"
                           placeholder="카테고리 입력" required>
                </div>
                <div class="col-md-3">
                    <label for="amount" class="form-label">금액</label>
                    <input type="number" id="amount" name="amount" class="form-control"
                           placeholder="금액 입력" step="0.01" required>
                </div>
                <div class="col-md-3">
                    <label for="date" class="form-label">날짜</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="col-md-12">
                    <label for="description" class="form-label">설명</label>
                    <input type="text" id="description" name="description" class="form-control"
                           placeholder="설명 입력">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100">저장</button>
        </form>
    </div>

    <!-- 달력 -->
    <div class="card form-card mb-4 p-3">
        <div class="calendar-nav mb-2">
            <button id="prevMonth" class="btn btn-outline-primary">&lt; 이전 달</button>
            <h5 id="calendarTitle" class="mb-0"></h5>
            <button id="nextMonth" class="btn btn-outline-primary">다음 달 &gt;</button>
        </div>
        <table class="table table-bordered text-center calendar-table mb-0">
            <thead class="table-light">
                <tr>
                    <th>일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th>토</th>
                </tr>
            </thead>
            <tbody id="calendarBody">
                <!-- JS로 채워짐 -->
            </tbody>
        </table>
    </div>
	<!-- 가계부 내역 모달 -->
	<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="eventModalLabel">가계부 내역</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        <p id="modalCategory"></p>
	        <p id="modalDescription"></p>
	        <p id="modalAmount"></p>
	      </div>
	      <div class="modal-footer d-flex justify-content-between">
	        <div>
	          <button type="button" id="editEventBtn" class="btn btn-primary">수정</button>
	          <button type="button" id="deleteEventBtn" class="btn btn-danger">삭제</button>
	        </div>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
	      </div>
	    </div>
	  </div>
	</div>
	<!-- 수정 모달 -->
	<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">가계부 내역 수정</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      <div class="modal-body">
	        <input type="hidden" id="editId">
			<div class="mb-3">
			  <label>타입</label>
			  <select id="editType" class="form-select">
			    <option value="INCOME">수입</option>
			    <option value="EXPENSE">지출</option>
			  </select>
			</div>
	        <div class="mb-3">
	          <label>카테고리</label>
	          <input type="text" id="editCategory" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>금액</label>
	          <input type="number" id="editAmount" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>날짜</label>
	          <input type="date" id="editDate" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>설명</label>
	          <textarea id="editDescription" class="form-control"></textarea>
	        </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" id="saveEditBtn" class="btn btn-primary">저장</button>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	      </div>
	    </div>
	  </div>
	</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    const state = { date: new Date() };
    let eventsByDate = {};
    let currentEvent = null; // 현재 클릭한 이벤트 저장

    // 서버에서 이벤트 가져오기
    async function loadEvents() {
        try {
            const res = await fetch('/incomeexpense/events', { credentials: 'same-origin' });
            if(!res.ok) throw new Error('events fetch failed: ' + res.status);
            const data = await res.json();
            eventsByDate = {};
            data.forEach(ev => {
                let key = ev.start;
                if(!eventsByDate[key]) eventsByDate[key] = [];
                eventsByDate[key].push(ev);
            });
        } catch(err) {
            console.error(err);
        }
    }

    // 달력 렌더링
    function renderCalendar() {
        const year = state.date.getFullYear();
        const month = state.date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        document.getElementById('calendarTitle').innerText = year + '년 ' + (month+1) + '월';
        const tbody = document.getElementById('calendarBody');
        tbody.innerHTML = '';
        let row = document.createElement('tr');

        for(let i=0; i<firstDay; i++) row.appendChild(document.createElement('td'));

        for(let day=1; day<=daysInMonth; day++){
            if(row.children.length === 7){ tbody.appendChild(row); row = document.createElement('tr'); }
            const cell = document.createElement('td');

            const dayNum = document.createElement('div');
            dayNum.className = 'calendar-day-number';
            dayNum.innerText = day;
            cell.appendChild(dayNum);

            const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const evs = eventsByDate[dateKey] || [];
            if(evs.length){
                const container = document.createElement('div');
                container.className = 'event-container';
                evs.forEach(ev => {
                    const div = document.createElement('div');
					const amount = Number(ev.title.split(' ')[1] || 0).toLocaleString(); 
					const type = ev.title.split(' ')[0]; // INCOME / EXPENSE
					const displayType = type === 'INCOME' ? '수입' : '지출';
                    div.className = ev.color==="green"?'event-income':'event-expense';
                    div.innerText = `${ev.category || ''} ${ev.title.split(' ')[1] || ''}원`;
					div.innerText = `${displayType} ${amount}원 (${ev.category || ''})`;
					div.addEventListener('click', ()=> {
					    currentEvent = ev;

					    // 수입/지출 구분 표시
					    const typeText = ev.color === "green" ? "수입" : "지출";
					    document.getElementById('modalCategory').innerText = "카테고리: " + (ev.category || '') + " (" + typeText + ")";

					    // 금액 천 단위 콤마 처리
					    const amount = ev.title.split(' ')[1] || '0';
					    const formattedAmount = Number(amount).toLocaleString();
					    document.getElementById('modalAmount').innerText = "금액: " + formattedAmount + "원";

					    document.getElementById('modalDescription').innerText = "설명: " + (ev.description || '');

					    new bootstrap.Modal(document.getElementById('eventModal')).show();
					});

                    container.appendChild(div);
                });
                cell.appendChild(container);
            }

            row.appendChild(cell);
        }
        while(row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
    }

	document.getElementById('prevMonth').addEventListener('click', async ()=>{
	    state.date.setMonth(state.date.getMonth() - 1);
	    renderCalendar();
	    await loadMonthlySummary(); 
	});

	document.getElementById('nextMonth').addEventListener('click', async ()=>{
	    state.date.setMonth(state.date.getMonth() + 1);
	    renderCalendar();
	    await loadMonthlySummary(); 
	});

	
	// ✅ 월별 요약 데이터 불러오기
	async function loadMonthlySummary() {
	    const year = state.date.getFullYear();
	    const month = state.date.getMonth() + 1;

	    try {
	        const res = await fetch(`/incomeexpense/summary?year=${year}&month=${month}`, {
	            credentials: 'same-origin'
	        });
	        if (!res.ok) throw new Error('요약 데이터 불러오기 실패');
	        const data = await res.json();

	        document.getElementById('summaryIncome').innerText = `${Number(data.income || 0).toLocaleString()}원`;
	        document.getElementById('summaryExpense').innerText = `${Number(data.expense || 0).toLocaleString()}원`;
	        document.getElementById('summaryBalance').innerText = `${Number(data.balance || 0).toLocaleString()}원`;

	    } catch (err) {
	        console.error(err);
	    }
	}


	// 삭제
	document.getElementById('deleteEventBtn').addEventListener('click', ()=>{
	    if(!currentEvent) return;
	    if(confirm('정말 삭제하시겠습니까?')){
	        fetch('/incomeexpense/delete?id='+currentEvent.id, { method:'POST', credentials:'same-origin' })
	            .then(res => {
	                if(!res.ok) throw new Error('삭제 실패');
	                alert('삭제가 완료되었습니다.');
	                location.reload(); // 페이지 새로고침
	            })
	            .catch(err=>alert('삭제 중 오류 발생: '+err));
	        bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
	    }
	});

	// DOM이 완전히 로드된 후 실행
	document.addEventListener('DOMContentLoaded', () => {

	    // 수정 버튼
	    const editBtn = document.getElementById('editEventBtn');
	    if (editBtn) {
	        editBtn.addEventListener('click', () => {
	            if (!currentEvent) {
	                alert('수정할 항목이 선택되지 않았습니다.');
	                return;
	            }

	            console.log('현재 이벤트 데이터:', currentEvent);

	            // 금액 처리
	            let amount = '';
	            if (currentEvent.extendedProps && currentEvent.extendedProps.amount) {
	                amount = currentEvent.extendedProps.amount;
	            } else if (currentEvent.title && currentEvent.title.includes(' ')) {
	                amount = currentEvent.title.split(' ')[1] || '';
	            }

	            // 날짜 처리 (Date 객체면 yyyy-MM-dd로 변환)
	            let dateValue = '';
	            if (currentEvent.start instanceof Date) {
	                dateValue = currentEvent.start.toISOString().split('T')[0];
	            } else {
	                dateValue = currentEvent.startStr || currentEvent.start || '';
	            }

	            // 모달 입력값 채우기
	            document.getElementById('editId').value = currentEvent.id;
	            document.getElementById('editType').value = currentEvent.extendedProps?.type || currentEvent.type || '';
	            document.getElementById('editCategory').value = currentEvent.extendedProps?.category || currentEvent.category || '';
	            document.getElementById('editAmount').value = amount;
	            document.getElementById('editDate').value = dateValue;
	            document.getElementById('editDescription').value = currentEvent.extendedProps?.description || currentEvent.description || '';

	            // 기존 모달 닫고 수정 모달 열기
	            const eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
	            if (eventModal) eventModal.hide();

	            new bootstrap.Modal(document.getElementById('editModal')).show();
	        });
	    }

		// 수정 모달 저장 버튼
		const saveBtn = document.getElementById('saveEditBtn');
		if (saveBtn) {
		    saveBtn.addEventListener('click', async () => {
		        const id = document.getElementById('editId').value;
		        const type = document.getElementById('editType').value.trim();
		        const category = document.getElementById('editCategory').value.trim();
		        const amount = document.getElementById('editAmount').value.trim();
		        const date = document.getElementById('editDate').value.trim();
		        const description = document.getElementById('editDescription').value.trim();

		        if (!id || !amount || !date) {
		            alert('필수 입력값이 누락되었습니다.');
		            return;
		        }

		        const formData = new URLSearchParams();
		        formData.append('id', id);
		        formData.append('type', type);
		        formData.append('category', category);
		        formData.append('amount', amount);
		        formData.append('date', date);
		        formData.append('description', description);

		        try {
		            const res = await fetch('/incomeexpense/update', {
		                method: 'POST',
		                body: formData,
		                credentials: 'same-origin',
		                headers: { 'X-Requested-With': 'XMLHttpRequest' }
		            });

		            if (!res.ok) throw new Error('수정 실패 (HTTP ' + res.status + ')');

		            const resultText = await res.text();
		            console.log('서버 응답:', resultText);

		            alert('수정이 완료되었습니다.');

		            // FullCalendar 이벤트 실시간 갱신
		            if (window.calendar && currentEvent) {
		                // ⚙️ title도 새 type 기준으로 강제 갱신
		                const typeLabel = (type === 'INCOME') ? '수입' : '지출';
		                currentEvent.setProp('title', `${typeLabel} ${amount}원`);

		                // ⚙️ 모든 확장 프로퍼티 덮어쓰기
		                currentEvent.setExtendedProp('type', type);
		                currentEvent.setExtendedProp('category', category);
		                currentEvent.setExtendedProp('amount', amount);
		                currentEvent.setExtendedProp('description', description);

		                // 날짜 갱신
		                currentEvent.setStart(date);
		                currentEvent.setEnd(date);

		                // 🔄 즉시 화면 반영
		                window.calendar.refetchEvents();
		            } else {
		                location.reload();
		            }
		        } catch (err) {
		            alert('수정 중 오류 발생: ' + err.message);
		            console.error('❌ 수정 오류:', err);
		        } finally {
		            const modalEl = document.getElementById('editModal');
		            const modalInstance = bootstrap.Modal.getInstance(modalEl);
		            if (modalInstance) modalInstance.hide();
		        }
		    });
		}
	});

	// 필터
	document.addEventListener('DOMContentLoaded', () => {
	    const filterForm = document.querySelector('form[th\\:action="@{/incomeexpense/filter}"]');

	    // 폼 제출 시 검증
	    filterForm.addEventListener('submit', (e) => {
	        const year = filterForm.querySelector('input[name="year"]').value.trim();
	        const month = filterForm.querySelector('input[name="month"]').value.trim();

	        if ((year && !month) || (!year && month)) {
	            e.preventDefault();
	            alert('년도와 월은 반드시 함께 입력해야 합니다.');
	        }
	    });

	    // 달력 월 이동 버튼과 필터 연동 (원하면)
	    const prevMonthBtn = document.getElementById('prevMonth');
	    const nextMonthBtn = document.getElementById('nextMonth');

	    prevMonthBtn.addEventListener('click', () => {
	        const yearInput = filterForm.querySelector('input[name="year"]');
	        const monthInput = filterForm.querySelector('input[name="month"]');

	        let year = parseInt(yearInput.value) || new Date().getFullYear();
	        let month = parseInt(monthInput.value) || new Date().getMonth() + 1;

	        month -= 1;
	        if (month < 1) {
	            month = 12;
	            year -= 1;
	        }

	        yearInput.value = year;
	        monthInput.value = month;
	        filterForm.submit();
	    });

	    nextMonthBtn.addEventListener('click', () => {
	        const yearInput = filterForm.querySelector('input[name="year"]');
	        const monthInput = filterForm.querySelector('input[name="month"]');

	        let year = parseInt(yearInput.value) || new Date().getFullYear();
	        let month = parseInt(monthInput.value) || new Date().getMonth() + 1;

	        month += 1;
	        if (month > 12) {
	            month = 1;
	            year += 1;
	        }

	        yearInput.value = year;
	        monthInput.value = month;
	        filterForm.submit();
	    });
	});

    // 초기화
    (async function init(){
        await loadEvents();
        renderCalendar();
		await loadMonthlySummary();
    })();
})();
</script>

</body>
</html>
