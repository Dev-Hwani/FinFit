<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>가계부 관리 | FinFit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .summary-card { border-radius: 12px; background-color: #f8f9fa; padding: 20px; }
        .summary-title { font-size: 1rem; color: #6c757d; }
        .summary-value { font-size: 1.5rem; font-weight: bold; }
        .ie-card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .ie-buttons button { margin-left: 5px; }
        .form-card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

        /* 달력 스타일 */
        .calendar-card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .calendar-table th, .calendar-table td { text-align: left; vertical-align: top; height: 110px; padding: 8px; }
        .calendar-day-number { font-weight: 700; display:block; margin-bottom:6px; }
        .event-badge { display:block; margin-top:4px; font-size:0.85rem; padding: .35rem .5rem; border-radius:.25rem; }
        .event-income { background-color:#cce5ff; color:#0f5132; }
        .event-expense { background-color:#f8d7da; color:#9a1b1b; }

        /* 달력 컨트롤 버튼 위치 조정 */
        .calendar-controls { gap:10px; }
        .small-muted { font-size:0.9rem; color:#6c757d; }
    </style>
</head>
<body>
<nav th:replace="~{navbar :: navbarFragment}"></nav>

<div class="container mt-5">
    <h1 class="mb-4 fw-bold text-center">가계부 관리</h1>

    <!-- 월별 요약 -->
    <div class="row text-center mb-4">
        <div class="col-md-4 mb-3">
            <div class="summary-card">
                <div class="summary-title">총 수입</div>
                <div class="summary-value text-primary"
                     th:text="${#numbers.formatDecimal(summary.income,0,'COMMA',2,'POINT')}">0</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="summary-card">
                <div class="summary-title">총 지출</div>
                <div class="summary-value text-danger"
                     th:text="${#numbers.formatDecimal(summary.expense,0,'COMMA',2,'POINT')}">0</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="summary-card">
                <div class="summary-title">잔액</div>
                <div class="summary-value"
                     th:text="${#numbers.formatDecimal(summary.balance,0,'COMMA',2,'POINT')}">0</div>
            </div>
        </div>
    </div>

    <!-- 가계부 입력 폼 -->
    <div class="card form-card mb-4 p-4">
        <h4 class="mb-3 fw-semibold">새 내역 추가</h4>
        <form th:action="@{/incomeexpense/save}" method="post">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="type" class="form-label">타입</label>
                    <select id="type" name="type" class="form-select" required>
                        <option value="INCOME">수입</option>
                        <option value="EXPENSE">지출</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">카테고리</label>
                    <input type="text" id="category" name="category" class="form-control"
                           placeholder="카테고리 입력" required>
                </div>
                <div class="col-md-3">
                    <label for="amount" class="form-label">금액</label>
                    <input type="number" id="amount" name="amount" class="form-control"
                           placeholder="금액 입력" step="0.01" required>
                </div>
                <div class="col-md-3">
                    <label for="date" class="form-label">날짜</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="col-md-12">
                    <label for="description" class="form-label">설명</label>
                    <input type="text" id="description" name="description" class="form-control"
                           placeholder="설명 입력">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100">저장</button>
        </form>
    </div>

    <!-- 달력 영역 (Bootstrap 테이블 기반) -->
    <div class="card calendar-card mb-4 p-3">
        <div class="d-flex justify-content-between align-items-center calendar-controls mb-3">
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="prevMonthBtn">&lt; 이전</button>
                <button class="btn btn-outline-secondary btn-sm" id="nextMonthBtn">다음 &gt;</button>
            </div>
            <div class="text-center">
                <h5 id="calendarTitle" class="mb-0"></h5>
                <div class="small-muted" id="calendarSubtitle">이벤트를 클릭하면 상세보기(구현 필요)</div>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="todayBtn">오늘</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered calendar-table">
                <thead class="table-light">
                    <tr>
                        <th>일</th>
                        <th>월</th>
                        <th>화</th>
                        <th>수</th>
                        <th>목</th>
                        <th>금</th>
                        <th>토</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <!-- JS로 채움 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 가계부 목록 -->
    <h4 class="mb-3 fw-bold">가계부 내역</h4>
    <div class="row g-3">
        <div class="col-md-4 mb-3" th:each="ie : ${incomeExpenses}">
            <div class="card ie-card p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold mb-1" th:text="${ie.category}">카테고리</div>
                        <div>
                            타입:
                            <span th:text="${ie.type}"
                                  th:classappend="(${ie.type} == 'INCOME') ? ' text-primary fw-bold' : ' text-danger fw-bold'">
                            </span>
                        </div>
                        <div>
                            금액:
                            <span th:text="${#numbers.formatDecimal(ie.amount,0,'COMMA',2,'POINT')}"></span>
                        </div>
                        <div>날짜: <span th:text="${ie.date}"></span></div>
                        <div th:if="${ie.description != null}">설명: <span th:text="${ie.description}"></span></div>
                    </div>
                    <div class="ie-buttons d-flex flex-column">
                        <button class="btn btn-sm btn-warning mb-2"
                                data-bs-toggle="modal"
                                th:data-bs-target="${'#editModal' + ie.id}">수정</button>
                        <form th:action="@{/incomeexpense/delete}" method="post" th:object="${ie}"
                              onsubmit="return confirm('정말 삭제하시겠습니까?');">
                            <input type="hidden" name="id" th:value="${ie.id}" />
                            <button type="submit" class="btn btn-sm btn-danger">삭제</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달: 수정 -->
    <div th:each="ie : ${incomeExpenses}" th:id="${'editModal' + ie.id}" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content p-3">
                <form th:action="@{/incomeexpense/update}" method="post">
                    <input type="hidden" name="id" th:value="${ie.id}" />
                    <div class="mb-3">
                        <label class="form-label">타입</label>
                        <select name="type" class="form-select" required>
                            <option th:selected="${ie.type == 'INCOME'}" value="INCOME">수입</option>
                            <option th:selected="${ie.type == 'EXPENSE'}" value="EXPENSE">지출</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카테고리</label>
                        <input type="text" name="category" class="form-control" th:value="${ie.category}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">금액</label>
                        <input type="number" name="amount" class="form-control" th:value="${ie.amount}" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">날짜</label>
                        <input type="date" name="date" class="form-control" th:value="${ie.date}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <input type="text" name="description" class="form-control" th:value="${ie.description}">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">수정 저장</button>
                </form>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- 달력 로직: 서버에서 /incomeexpense/events 로 JSON 받아와서 테이블에 배치 -->
<script>
(function(){
    // 현재 보이는 연월을 관리
    const state = { date: new Date() };

    // 날짜 -> 이벤트 목록 맵 (yyyy-mm-dd -> [events])
    let eventsByDate = {};

    // 서버에서 이벤트 불러오기
    async function loadEvents() {
        try {
            const res = await fetch('/incomeexpense/events', { credentials: 'same-origin' });
            if (!res.ok) throw new Error('events fetch failed: ' + res.status);
            const data = await res.json();
            // data expected: [{title, start, color, category, description}, ...]
            eventsByDate = {};
            data.forEach(ev => {
                // ensure date format yyyy-mm-dd
                const d = ev.start;
                if (!eventsByDate[d]) eventsByDate[d] = [];
                eventsByDate[d].push(ev);
            });
        } catch (err) {
            console.error('Failed to load events:', err);
            eventsByDate = {}; // fallback empty
        }
    }

    // 캘린더 렌더
    function renderCalendar() {
        const date = state.date;
        const year = date.getFullYear();
        const month = date.getMonth(); // 0-indexed
        const firstOfMonth = new Date(year, month, 1);
        const lastOfMonth = new Date(year, month + 1, 0);
        const startWeekday = firstOfMonth.getDay(); // 0=Sun..6=Sat
        const daysInMonth = lastOfMonth.getDate();

        document.getElementById('calendarTitle').innerText = `${year}년 ${month+1}월`;

        const tbody = document.getElementById('calendarBody');
        tbody.innerHTML = '';

        let row = document.createElement('tr');
        // fill leading empty cells
        for (let i = 0; i < startWeekday; i++) {
            const empty = document.createElement('td');
            row.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            if (row.children.length === 7) {
                tbody.appendChild(row);
                row = document.createElement('tr');
            }

            const cell = document.createElement('td');
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

            // day number
            const dayNum = document.createElement('div');
            dayNum.className = 'calendar-day-number';
            dayNum.innerText = day;
            cell.appendChild(dayNum);

            // attach events if any
            const evs = eventsByDate[dateStr];
            if (evs && evs.length) {
                evs.forEach(ev => {
                    const badge = document.createElement('div');
                    badge.className = 'event-badge ' + (ev.color === 'green' || ev.color === 'INCOME' || ev.color === 'income' ? 'event-income' : 'event-expense');
                    // display category + amount or title
                    let label = '';
                    if (ev.category) label += ev.category;
                    if (ev.description) label += (label ? ' - ' : '') + ev.description;
                    // show title or amount fallback
                    if (!label) label = ev.title || '';
                    badge.innerText = label;
                    // click handler to open modal if exists (by matching date/title -> optional)
                    badge.style.cursor = 'pointer';
                    badge.addEventListener('click', function() {
                        // Try to find matching modal by event data (if your modal ids are 'editModal' + id and server provides id)
                        // If event has id and modal exists, show it:
                        if (ev.id) {
                            const modalEl = document.getElementById('editModal' + ev.id);
                            if (modalEl) {
                                const bsModal = new bootstrap.Modal(modalEl);
                                bsModal.show();
                                return;
                            }
                        }
                        // Otherwise, simple alert as fallback:
                        if (ev.title || ev.category || ev.description) {
                            alert((ev.title ? ev.title + '\n' : '') + (ev.category ? '카테고리: ' + ev.category + '\n' : '') + (ev.description ? '설명: ' + ev.description : ''));
                        }
                    });
                    cell.appendChild(badge);
                });
            }

            row.appendChild(cell);
        }

        // fill trailing empty cells
        while (row.children.length < 7) {
            row.appendChild(document.createElement('td'));
        }
        tbody.appendChild(row);
    }

    // navigation handlers
    function prevMonth() { state.date.setMonth(state.date.getMonth() - 1); renderCalendar(); }
    function nextMonth() { state.date.setMonth(state.date.getMonth() + 1); renderCalendar(); }
    function goToday() { state.date = new Date(); renderCalendar(); }

    document.getElementById('prevMonthBtn').addEventListener('click', () => { prevMonth(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { nextMonth(); });
    document.getElementById('todayBtn').addEventListener('click', () => { goToday(); });

    // 초기 로드: 이벤트 가져오고 캘린더 렌더
    (async function init() {
        await loadEvents();
        renderCalendar();
    })();

})();
</script>
</body>
</html>
