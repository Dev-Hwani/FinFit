<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°€ê³„ë¶€ ê´€ë¦¬ | FinFit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<nav th:replace="~{navbar :: navbarFragment}"></nav>

<div class="container mt-5">
    <h1 class="mb-4 fw-bold text-center">ê°€ê³„ë¶€ ê´€ë¦¬</h1>

	<!-- ì›”ë³„ ìš”ì•½ -->
	<div class="row text-center mb-4">
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">ì´ ìˆ˜ì…</div>
	            <div id="summaryIncome" class="summary-value text-primary"
	                 th:text="${#numbers.formatDecimal(summary.income,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">ì´ ì§€ì¶œ</div>
	            <div id="summaryExpense" class="summary-value text-danger"
	                 th:text="${#numbers.formatDecimal(summary.expense,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	    <div class="col-md-4 mb-3">
	        <div class="summary-card">
	            <div class="summary-title">ì”ì•¡</div>
	            <div id="summaryBalance" class="summary-value"
	                 th:text="${#numbers.formatDecimal(summary.balance,0,'COMMA',0,'POINT')}">0</div>
	        </div>
	    </div>
	</div>

    <!-- ê°€ê³„ë¶€ ì…ë ¥ í¼ -->
    <div class="card form-card mb-4 p-4">
        <h4 class="mb-3 fw-semibold">ìƒˆ ë‚´ì—­ ì¶”ê°€</h4>
        <form th:action="@{/incomeexpense/save}" method="post">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="type" class="form-label">íƒ€ì…</label>
                    <select id="type" name="type" class="form-select" required>
                        <option value="INCOME">ìˆ˜ì…</option>
                        <option value="EXPENSE">ì§€ì¶œ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" id="category" name="category" class="form-control"
                           placeholder="ì¹´í…Œê³ ë¦¬ ì…ë ¥" required>
                </div>
                <div class="col-md-3">
                    <label for="amount" class="form-label">ê¸ˆì•¡</label>
                    <input type="number" id="amount" name="amount" class="form-control"
                           placeholder="ê¸ˆì•¡ ì…ë ¥" step="0.01" required>
                </div>
                <div class="col-md-3">
                    <label for="date" class="form-label">ë‚ ì§œ</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="col-md-12">
                    <label for="description" class="form-label">ì„¤ëª…</label>
                    <input type="text" id="description" name="description" class="form-control"
                           placeholder="ì„¤ëª… ì…ë ¥">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100">ì €ì¥</button>
        </form>
    </div>

    <!-- ë‹¬ë ¥ -->
    <div class="card form-card mb-4 p-3">
        <div class="calendar-nav mb-2">
            <button id="prevMonth" class="btn btn-outline-primary">&lt; ì´ì „ ë‹¬</button>
            <h5 id="calendarTitle" class="mb-0"></h5>
            <button id="nextMonth" class="btn btn-outline-primary">ë‹¤ìŒ ë‹¬ &gt;</button>
        </div>
        <table class="table table-bordered text-center calendar-table mb-0">
            <thead class="table-light">
                <tr>
                    <th>ì¼</th>
                    <th>ì›”</th>
                    <th>í™”</th>
                    <th>ìˆ˜</th>
                    <th>ëª©</th>
                    <th>ê¸ˆ</th>
                    <th>í† </th>
                </tr>
            </thead>
            <tbody id="calendarBody">
                <!-- JSë¡œ ì±„ì›Œì§ -->
            </tbody>
        </table>
    </div>
	<!-- ê°€ê³„ë¶€ ë‚´ì—­ ëª¨ë‹¬ -->
	<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="eventModalLabel">ê°€ê³„ë¶€ ë‚´ì—­</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        <p id="modalCategory"></p>
	        <p id="modalDescription"></p>
	        <p id="modalAmount"></p>
	      </div>
	      <div class="modal-footer d-flex justify-content-between">
	        <div>
	          <button type="button" id="editEventBtn" class="btn btn-primary">ìˆ˜ì •</button>
	          <button type="button" id="deleteEventBtn" class="btn btn-danger">ì‚­ì œ</button>
	        </div>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	      </div>
	    </div>
	  </div>
	</div>
	<!-- ìˆ˜ì • ëª¨ë‹¬ -->
	<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">ê°€ê³„ë¶€ ë‚´ì—­ ìˆ˜ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      <div class="modal-body">
	        <input type="hidden" id="editId">
			<div class="mb-3">
			  <label>íƒ€ì…</label>
			  <select id="editType" class="form-select">
			    <option value="INCOME">ìˆ˜ì…</option>
			    <option value="EXPENSE">ì§€ì¶œ</option>
			  </select>
			</div>
	        <div class="mb-3">
	          <label>ì¹´í…Œê³ ë¦¬</label>
	          <input type="text" id="editCategory" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>ê¸ˆì•¡</label>
	          <input type="number" id="editAmount" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>ë‚ ì§œ</label>
	          <input type="date" id="editDate" class="form-control">
	        </div>
	        <div class="mb-3">
	          <label>ì„¤ëª…</label>
	          <textarea id="editDescription" class="form-control"></textarea>
	        </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" id="saveEditBtn" class="btn btn-primary">ì €ì¥</button>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
	      </div>
	    </div>
	  </div>
	</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    const state = { date: new Date() };
    let eventsByDate = {};
    let currentEvent = null; // í˜„ì¬ í´ë¦­í•œ ì´ë²¤íŠ¸ ì €ì¥

    // ì„œë²„ì—ì„œ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    async function loadEvents() {
        try {
            const res = await fetch('/incomeexpense/events', { credentials: 'same-origin' });
            if(!res.ok) throw new Error('events fetch failed: ' + res.status);
            const data = await res.json();
            eventsByDate = {};
            data.forEach(ev => {
                let key = ev.start;
                if(!eventsByDate[key]) eventsByDate[key] = [];
                eventsByDate[key].push(ev);
            });
        } catch(err) {
            console.error(err);
        }
    }

    // ë‹¬ë ¥ ë Œë”ë§
    function renderCalendar() {
        const year = state.date.getFullYear();
        const month = state.date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        document.getElementById('calendarTitle').innerText = year + 'ë…„ ' + (month+1) + 'ì›”';
        const tbody = document.getElementById('calendarBody');
        tbody.innerHTML = '';
        let row = document.createElement('tr');

        for(let i=0; i<firstDay; i++) row.appendChild(document.createElement('td'));

        for(let day=1; day<=daysInMonth; day++){
            if(row.children.length === 7){ tbody.appendChild(row); row = document.createElement('tr'); }
            const cell = document.createElement('td');

            const dayNum = document.createElement('div');
            dayNum.className = 'calendar-day-number';
            dayNum.innerText = day;
            cell.appendChild(dayNum);

            const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const evs = eventsByDate[dateKey] || [];
            if(evs.length){
                const container = document.createElement('div');
                container.className = 'event-container';
                evs.forEach(ev => {
                    const div = document.createElement('div');
					const amount = Number(ev.title.split(' ')[1] || 0).toLocaleString(); 
					const type = ev.title.split(' ')[0]; // INCOME / EXPENSE
					const displayType = type === 'INCOME' ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
                    div.className = ev.color==="green"?'event-income':'event-expense';
                    div.innerText = `${ev.category || ''} ${ev.title.split(' ')[1] || ''}ì›`;
					div.innerText = `${displayType} ${amount}ì› (${ev.category || ''})`;
					div.addEventListener('click', ()=> {
					    currentEvent = ev;

					    // ìˆ˜ì…/ì§€ì¶œ êµ¬ë¶„ í‘œì‹œ
					    const typeText = ev.color === "green" ? "ìˆ˜ì…" : "ì§€ì¶œ";
					    document.getElementById('modalCategory').innerText = "ì¹´í…Œê³ ë¦¬: " + (ev.category || '') + " (" + typeText + ")";

					    // ê¸ˆì•¡ ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì²˜ë¦¬
					    const amount = ev.title.split(' ')[1] || '0';
					    const formattedAmount = Number(amount).toLocaleString();
					    document.getElementById('modalAmount').innerText = "ê¸ˆì•¡: " + formattedAmount + "ì›";

					    document.getElementById('modalDescription').innerText = "ì„¤ëª…: " + (ev.description || '');

					    new bootstrap.Modal(document.getElementById('eventModal')).show();
					});

                    container.appendChild(div);
                });
                cell.appendChild(container);
            }

            row.appendChild(cell);
        }
        while(row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
    }

	document.getElementById('prevMonth').addEventListener('click', async ()=>{
	    state.date.setMonth(state.date.getMonth() - 1);
	    renderCalendar();
	    await loadMonthlySummary(); 
	});

	document.getElementById('nextMonth').addEventListener('click', async ()=>{
	    state.date.setMonth(state.date.getMonth() + 1);
	    renderCalendar();
	    await loadMonthlySummary(); 
	});

	
	// âœ… ì›”ë³„ ìš”ì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
	async function loadMonthlySummary() {
	    const year = state.date.getFullYear();
	    const month = state.date.getMonth() + 1;

	    try {
	        const res = await fetch(`/incomeexpense/summary?year=${year}&month=${month}`, {
	            credentials: 'same-origin'
	        });
	        if (!res.ok) throw new Error('ìš”ì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
	        const data = await res.json();

	        document.getElementById('summaryIncome').innerText = `${Number(data.income || 0).toLocaleString()}ì›`;
	        document.getElementById('summaryExpense').innerText = `${Number(data.expense || 0).toLocaleString()}ì›`;
	        document.getElementById('summaryBalance').innerText = `${Number(data.balance || 0).toLocaleString()}ì›`;

	    } catch (err) {
	        console.error(err);
	    }
	}


	// ì‚­ì œ
	document.getElementById('deleteEventBtn').addEventListener('click', ()=>{
	    if(!currentEvent) return;
	    if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
	        fetch('/incomeexpense/delete?id='+currentEvent.id, { method:'POST', credentials:'same-origin' })
	            .then(res => {
	                if(!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
	                alert('ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
	                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
	            })
	            .catch(err=>alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: '+err));
	        bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
	    }
	});

	// DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
	document.addEventListener('DOMContentLoaded', () => {

	    // ìˆ˜ì • ë²„íŠ¼
	    const editBtn = document.getElementById('editEventBtn');
	    if (editBtn) {
	        editBtn.addEventListener('click', () => {
	            if (!currentEvent) {
	                alert('ìˆ˜ì •í•  í•­ëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
	                return;
	            }

	            console.log('í˜„ì¬ ì´ë²¤íŠ¸ ë°ì´í„°:', currentEvent);

	            // ê¸ˆì•¡ ì²˜ë¦¬
	            let amount = '';
	            if (currentEvent.extendedProps && currentEvent.extendedProps.amount) {
	                amount = currentEvent.extendedProps.amount;
	            } else if (currentEvent.title && currentEvent.title.includes(' ')) {
	                amount = currentEvent.title.split(' ')[1] || '';
	            }

	            // ë‚ ì§œ ì²˜ë¦¬ (Date ê°ì²´ë©´ yyyy-MM-ddë¡œ ë³€í™˜)
	            let dateValue = '';
	            if (currentEvent.start instanceof Date) {
	                dateValue = currentEvent.start.toISOString().split('T')[0];
	            } else {
	                dateValue = currentEvent.startStr || currentEvent.start || '';
	            }

	            // ëª¨ë‹¬ ì…ë ¥ê°’ ì±„ìš°ê¸°
	            document.getElementById('editId').value = currentEvent.id;
	            document.getElementById('editType').value = currentEvent.extendedProps?.type || currentEvent.type || '';
	            document.getElementById('editCategory').value = currentEvent.extendedProps?.category || currentEvent.category || '';
	            document.getElementById('editAmount').value = amount;
	            document.getElementById('editDate').value = dateValue;
	            document.getElementById('editDescription').value = currentEvent.extendedProps?.description || currentEvent.description || '';

	            // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê³  ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
	            const eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
	            if (eventModal) eventModal.hide();

	            new bootstrap.Modal(document.getElementById('editModal')).show();
	        });
	    }

		// ìˆ˜ì • ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
		const saveBtn = document.getElementById('saveEditBtn');
		if (saveBtn) {
		    saveBtn.addEventListener('click', async () => {
		        const id = document.getElementById('editId').value;
		        const type = document.getElementById('editType').value.trim();
		        const category = document.getElementById('editCategory').value.trim();
		        const amount = document.getElementById('editAmount').value.trim();
		        const date = document.getElementById('editDate').value.trim();
		        const description = document.getElementById('editDescription').value.trim();

		        if (!id || !amount || !date) {
		            alert('í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
		            return;
		        }

		        const formData = new URLSearchParams();
		        formData.append('id', id);
		        formData.append('type', type);
		        formData.append('category', category);
		        formData.append('amount', amount);
		        formData.append('date', date);
		        formData.append('description', description);

		        try {
		            const res = await fetch('/incomeexpense/update', {
		                method: 'POST',
		                body: formData,
		                credentials: 'same-origin',
		                headers: { 'X-Requested-With': 'XMLHttpRequest' }
		            });

		            if (!res.ok) throw new Error('ìˆ˜ì • ì‹¤íŒ¨ (HTTP ' + res.status + ')');

		            const resultText = await res.text();
		            console.log('ì„œë²„ ì‘ë‹µ:', resultText);

		            alert('ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

		            // FullCalendar ì´ë²¤íŠ¸ ì‹¤ì‹œê°„ ê°±ì‹ 
		            if (window.calendar && currentEvent) {
		                // âš™ï¸ titleë„ ìƒˆ type ê¸°ì¤€ìœ¼ë¡œ ê°•ì œ ê°±ì‹ 
		                const typeLabel = (type === 'INCOME') ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
		                currentEvent.setProp('title', `${typeLabel} ${amount}ì›`);

		                // âš™ï¸ ëª¨ë“  í™•ì¥ í”„ë¡œí¼í‹° ë®ì–´ì“°ê¸°
		                currentEvent.setExtendedProp('type', type);
		                currentEvent.setExtendedProp('category', category);
		                currentEvent.setExtendedProp('amount', amount);
		                currentEvent.setExtendedProp('description', description);

		                // ë‚ ì§œ ê°±ì‹ 
		                currentEvent.setStart(date);
		                currentEvent.setEnd(date);

		                // ğŸ”„ ì¦‰ì‹œ í™”ë©´ ë°˜ì˜
		                window.calendar.refetchEvents();
		            } else {
		                location.reload();
		            }
		        } catch (err) {
		            alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
		            console.error('âŒ ìˆ˜ì • ì˜¤ë¥˜:', err);
		        } finally {
		            const modalEl = document.getElementById('editModal');
		            const modalInstance = bootstrap.Modal.getInstance(modalEl);
		            if (modalInstance) modalInstance.hide();
		        }
		    });
		}
	});

	// í•„í„°
	document.addEventListener('DOMContentLoaded', () => {
	    const filterForm = document.querySelector('form[th\\:action="@{/incomeexpense/filter}"]');

	    // í¼ ì œì¶œ ì‹œ ê²€ì¦
	    filterForm.addEventListener('submit', (e) => {
	        const year = filterForm.querySelector('input[name="year"]').value.trim();
	        const month = filterForm.querySelector('input[name="month"]').value.trim();

	        if ((year && !month) || (!year && month)) {
	            e.preventDefault();
	            alert('ë…„ë„ì™€ ì›”ì€ ë°˜ë“œì‹œ í•¨ê»˜ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
	        }
	    });

	    // ë‹¬ë ¥ ì›” ì´ë™ ë²„íŠ¼ê³¼ í•„í„° ì—°ë™ (ì›í•˜ë©´)
	    const prevMonthBtn = document.getElementById('prevMonth');
	    const nextMonthBtn = document.getElementById('nextMonth');

	    prevMonthBtn.addEventListener('click', () => {
	        const yearInput = filterForm.querySelector('input[name="year"]');
	        const monthInput = filterForm.querySelector('input[name="month"]');

	        let year = parseInt(yearInput.value) || new Date().getFullYear();
	        let month = parseInt(monthInput.value) || new Date().getMonth() + 1;

	        month -= 1;
	        if (month < 1) {
	            month = 12;
	            year -= 1;
	        }

	        yearInput.value = year;
	        monthInput.value = month;
	        filterForm.submit();
	    });

	    nextMonthBtn.addEventListener('click', () => {
	        const yearInput = filterForm.querySelector('input[name="year"]');
	        const monthInput = filterForm.querySelector('input[name="month"]');

	        let year = parseInt(yearInput.value) || new Date().getFullYear();
	        let month = parseInt(monthInput.value) || new Date().getMonth() + 1;

	        month += 1;
	        if (month > 12) {
	            month = 1;
	            year += 1;
	        }

	        yearInput.value = year;
	        monthInput.value = month;
	        filterForm.submit();
	    });
	});

    // ì´ˆê¸°í™”
    (async function init(){
        await loadEvents();
        renderCalendar();
		await loadMonthlySummary();
    })();
})();
</script>

</body>
</html>
